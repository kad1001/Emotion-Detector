<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css"> -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/css/bootstrap.min.css" integrity="sha384-GJzZqFGwb1QTTN6wy59ffF1BuGJpLSa9DkKMp0DgiMDm4iYMj70gZWKYbI706tWS"
        crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" media="screen" href="assets/css/style.css" />

        <!-- faceapi javascript -->
  <script src="faceapi_commons.js"></script>

  <!-- jQuery -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>

<script type="text/javascript" src="faceapi_exif.js"></script>
<script type="text/javascript" src="face_detection.js"></script>

<meta name="viewport" content="width=device-width,initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">

<!-- for proper image sizing and analyzing -->
  <script type="text/javascript" src="faceapi_display.js"></script>
  <link rel="stylesheet" type="text/css" media="screen" href="assets/css/style.css" />

    <title>SurFace</title>
</head>
<body>
    <header>
        <ul class="main-nav">
            <li class="active"><a href="">HOME</a></li>
            <li><a href="index1.html">COMPARE</a></li>
            <li><a href="index.html">EMOTION</a></li>
        </ul>
        <div><h1>S u r F a c e</h1></div>
    </header>
    <div id="container">
        <form action="#">
            <div id="box">
                <button type="button" id="search" class="btn btn-secondary">Photo Search</button>
                <!-- <input id="people-search" type="text"> -->
            </div>
        </form>

        <!-- <div id="random-photo"></div> -->
        <div class="card random-photo" style="width: 18rem; height: 18rem;">
            <div class="card-header">
                Random Photograph
            </div>
        </div>
    </div>
    <hr>
    <h3 id="photos">Similar Faces</h3>
    <div id="similar-photos"></div>

    <script>
        // resets container when user wants to add a new image
    //     resetContainer();
    //     function clickInput(){
    //         document.getElementById('input').click();
    //    }
    </script>

    <script>
    $("#search").on("click", function () {
        var queryURL = "https://api.pexels.com/v1/search?query=face&per_page=1&page=1";
       $.ajax({
               url: queryURL,
               method: "GET",
               beforeSend: function(xhr){xhr.setRequestHeader("authorization", "563492ad6f91700001000001ef9932d9916848898cc2c5b1b0ec5725");}
       }).then(function (response) {
           var photo = response.photos;
           var image = $("<img>");
           image.attr({
               src: photo[0].src.small
           });
           $("#face-container").append(image);
        });
    });
    
    var facepp = new FACEPP('tofb2KC3K9WNkY2-A_VISLJVjWMQh5Df', 'xMmnpBZx-r-3xNFAZJUGKXLnLAEFG4Ls', 1);
    
    // get entered URL
    function selectImage(input){
        let imageView = document.getElementById('preview');
    
        const reader = new FileReader();
    
        reader.readAsDataURL(input.files[0]);
    
        reader.onload = function (e) {
    
            $("#facesContainer div").remove();
    
            //base64 data for the image
            const base64Image = e.target.result;
    
            fixOrientention(base64Image,imageView);
    
            //URL way to upload images
            let dic = {'image_url' : base64Image};
    
            facepp.detectFace(dic,success,failed);
    
            
            // turn image (base64) into binary
            let imageData = facepp.dataURItoBlob(base64Image);
          
            let attributes = 'gender,age,smiling,headpose,facequality,blur,eyestatus,emotion,ethnicity,beauty,mouthstatus,eyegaze,skinstatus';
    
            let dataDic = {'image_file':imageData,'return_landmark':2,'return_attributes':attributes};
            console.log(dataDic);
    
            facepp.detectFace(dataDic,success,failed);
        }
    }
    
    //reads image and returns json parameters
    function success(e){
    
        console.log(e);
        let textView = document.getElementById('text');
        textView.innerText = JSON.stringify(e,null,"\t");
    
        let imageView = document.getElementById('preview');
    
        const faces = e.faces;
    
        for (const index in faces){
            const face = faces[index];
    
            // a rectangle area for the face location on the image - holds coordinates of face area
            const face_rectangle = face.face_rectangle;
    
            var roll = face.attributes.headpose.roll_angle;
    
            //gender attribute
            var gender = face.attributes.gender.value;
            console.log("Gender: " + gender);
            // append to html
            $("#genderScore").text(gender);
    
            // emotion object
            // returns a number value (0-100)
            var emotion = face.attributes.emotion;
            var anger = emotion.anger;
            var disgust = emotion.disgust;
            var sadness = emotion.sadness;
            var surprise = emotion.surprise;
            var fear = emotion.fear;
            var happiness = emotion.happiness;
    
            console.log("emotion response: " + emotion);
            // append to html
            $("#emotionsScore").text(face.attributes.emotion.happiness);
    
            // female beauty score
            $("#FbeautyScore").text(face.attributes.beauty.female_score);
            // male beauty score
            $("#MbeautyScore").text(face.attributes.beauty.male_score);
          
    
            // changes border color of face container based on gender
            const borderColor = (gender == 'Male') ? 'blue' : 'red';
    
            console.log('face frame colorï¼š' + borderColor);
    
            // gets coordinates of face area
            var faceX = face_rectangle.left;
            var faceY = face_rectangle.top;
            var faceW = face_rectangle.width;
            var faceH = face_rectangle.height;
    
            //square face container
            var width = 320;
            var height = 320;
    
            var imageW = imageView.width;
            var imageH = imageView.height;
    
            var naturalWidth = imageView.naturalWidth;
            var naturalHeight = imageView.naturalHeight;
    
            const scale = imageW / naturalWidth;
    
            console.log('scale > ' + scale);
            // scales image
            const offsetX = (width - imageW)*0.5;
            const offsetY = (height - imageH)*0.5;
    
        
            $('<div/>').css({
                position: 'absolute',
                top: faceY * scale + offsetY,
                left: faceX * scale + offsetX,
                height: faceH * scale,
                width: faceW * scale,
                border: '2px solid ' + borderColor,
                transform: 'rotate(' + roll + 'deg)'
            }).appendTo($("#facesContainer"));
        }
    }
    
    //if this fails --
    function failed(e){
        console.log(e);
        let textView = document.getElementById('text');
        textView.innerText = JSON.stringify(e);
    }
    
    //orientation for face area container
    function fixOrientention(base64Image,imageView) {
        const image = new Image();
    
        image.onload = () => {
            const canvas = document.createElement('canvas');
    
            const initSize = image.src.length;
    
            let width = image.naturalWidth;
            let height = image.naturalHeight;
    
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
    
            EXIF.getData(image, function () {
                const orientation = EXIF.getTag(this, 'Orientation');
                console.log(`orientation:${orientation}`);
                switch (orientation) {
    
                    case 1:
                        canvas.height = height;
                        canvas.width = width;
                        ctx.drawImage(image, 0, 0, width, height);
                        break;
    
                    case 6:
                        canvas.height = width;
                        canvas.width = height;
                        ctx.rotate(Math.PI / 2);
                        ctx.translate(0, -height);
                        ctx.drawImage(image, 0, 0, width, height);
                        break;
    
                    case 3:
                        canvas.height = height;
                        canvas.width = width;
                        ctx.rotate(Math.PI);
                        ctx.translate(-width, -height);
                        ctx.drawImage(image, 0, 0, width, height);
                        break;
    
                    case 8:
                        canvas.height = width;
                        canvas.width = height;
                        ctx.rotate(-Math.PI / 2);
                        ctx.translate(-width, 0);
                        ctx.drawImage(image, 0, 0, width, height);
                        break;
    
                    default:
                        canvas.height = height;
                        canvas.width = width;
                        ctx.drawImage(image, 0, 0, width, height);
                        break;
                }
            });
    
            // canvas method
            var newBase64 = canvas.toDataURL('image/jpeg', 1.0);
            imageView.src = newBase64;
        };
        image.src = base64Image;
    }
      </script>
</body>
</html>